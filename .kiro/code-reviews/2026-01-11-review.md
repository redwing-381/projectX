# Code Review - January 11, 2026

**Reviewer:** Kiro AI  
**Scope:** Recent changes (web dashboard, CLI, CrewAI agents, database layer)

---

## Summary

Overall code quality is good. Found 3 medium issues and 5 low issues. No critical or high severity issues detected.

---

## Issues Found

### Issue 1
```
severity: medium
file: src/api/web.py
line: 47-60 (repeated pattern)
issue: Database session management is duplicated across all route handlers
suggestion: Use FastAPI's Depends(get_db) pattern instead of manual SessionLocal() calls. This reduces code duplication and ensures proper cleanup.
```

**Current pattern (repeated 8+ times):**
```python
if engine is not None:
    try:
        from src.db.database import SessionLocal
        db = SessionLocal()
        try:
            # ... operations
        finally:
            db.close()
    except Exception as e:
        logger.warning(f"...")
```

**Suggested pattern:**
```python
@router.get("/")
async def dashboard(request: Request, db: Session = Depends(get_db)):
    stats = crud.get_today_stats(db) if db else {}
    # ...
```

---

### Issue 2
```
severity: medium
file: src/main.py
line: 10
issue: Unused import - StaticFiles is imported but never used
suggestion: Remove unused import to keep code clean
```

---

### Issue 3
```
severity: medium
file: src/services/pipeline.py
line: 143-156
issue: Dead code - _save_and_return method is defined but never called
suggestion: Remove unused method or integrate it into _process_email
```

---

### Issue 4
```
severity: low
file: src/db/crud.py
line: 117
issue: is_vip_sender loads ALL VIP senders into memory for each check
suggestion: For large VIP lists, consider a single SQL query with LIKE/ILIKE instead of loading all records
```

**Current:**
```python
vip_senders = db.query(VIPSender).all()
for vip in vip_senders:
    # check each one
```

**Better for scale:**
```python
# Use SQL pattern matching directly
return db.query(VIPSender).filter(
    or_(
        VIPSender.email_or_domain == email_lower,
        literal(email_lower).contains(VIPSender.email_or_domain)
    )
).first() is not None
```

---

### Issue 5
```
severity: low
file: cli/main.py
line: 1-232
issue: Missing type hints on some function parameters
suggestion: Add type hints for consistency (e.g., handle_error return type -> None)
```

---

### Issue 6
```
severity: low
file: src/agents/classifier.py
line: 33-50
issue: check_vip_and_keywords catches all exceptions silently
suggestion: Log at INFO level instead of DEBUG for production visibility
```

---

### Issue 7
```
severity: low
file: src/db/database.py
line: 47
issue: get_db_session return type annotation is incorrect (Session vs Generator)
suggestion: Change to -> Generator[Session, None, None] or use Iterator[Session]
```

---

### Issue 8
```
severity: low
file: src/api/web.py
line: 282
issue: toggle_monitoring endpoint does nothing - just redirects
suggestion: Either implement the functionality or add a TODO comment explaining the limitation
```

---

## Positive Observations

✅ **Good error handling** - Graceful fallbacks throughout (CrewAI → direct classifier, DB errors don't crash app)

✅ **Consistent logging** - All modules use proper logging with appropriate levels

✅ **Type hints** - Most functions have proper type annotations

✅ **Docstrings** - Public functions are well documented

✅ **Security** - No hardcoded secrets, proper use of environment variables

✅ **Code organization** - Clear separation of concerns (agents, services, db, api)

✅ **Database safety** - Connection pooling, pre-ping, proper session cleanup

---

## Recommendations

1. **Refactor web.py** - Extract the repeated DB session pattern into a helper or use Depends properly
2. **Remove dead code** - Clean up unused imports and methods
3. **Add integration tests** - Current tests are unit/property tests; add API endpoint tests
4. **Consider caching** - VIP senders and keywords could be cached to reduce DB queries

---

## Verdict

**Code review passed with minor issues.** The codebase is production-ready for the hackathon. The issues found are improvements rather than bugs.
