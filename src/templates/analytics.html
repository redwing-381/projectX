{% extends "base.html" %}

{% block title %}Analytics - ProjectX{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 style="font-size: 24px; font-weight: 700; margin: 0;">Analytics</h1>
        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Email processing insights and trends</p>
    </div>
</div>

<div class="page-content">
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #fafafa;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Total Messages</span>
            </div>
            <div style="font-size: 28px; font-weight: 700;">{{ metrics.total_messages }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Total Alerts</span>
            </div>
            <div style="font-size: 28px; font-weight: 700;">{{ metrics.total_alerts }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Alert Rate</span>
            </div>
            <div style="font-size: 28px; font-weight: 700;">{{ metrics.alert_rate }}%</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Today</span>
            </div>
            <div style="font-size: 28px; font-weight: 700;">{{ metrics.today_emails }}<span style="font-size: 14px; color: var(--text-muted); font-weight: 400;"> / {{ metrics.today_alerts }} alerts</span></div>
        </div>
    </div>

    <!-- Source Breakdown Cards -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: #3b82f6;"></span>
                <span style="font-size: 12px; color: var(--text-muted);">Emails</span>
            </div>
            <div style="font-size: 22px; font-weight: 600;">{{ metrics.source_breakdown.email }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: #25d366;"></span>
                <span style="font-size: 12px; color: var(--text-muted);">WhatsApp</span>
            </div>
            <div style="font-size: 22px; font-weight: 600;">{{ metrics.source_breakdown.whatsapp }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: #0088cc;"></span>
                <span style="font-size: 12px; color: var(--text-muted);">Telegram</span>
            </div>
            <div style="font-size: 22px; font-weight: 600;">{{ metrics.source_breakdown.telegram }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: #a3a3a3;"></span>
                <span style="font-size: 12px; color: var(--text-muted);">Other Apps</span>
            </div>
            <div style="font-size: 22px; font-weight: 600;">{{ metrics.source_breakdown.other }}</div>
        </div>
    </div>

    <style>
        @media (max-width: 900px) {
            .page-content > div:first-child { grid-template-columns: repeat(2, 1fr) !important; }
        }
        @media (max-width: 500px) {
            .page-content > div:first-child { grid-template-columns: 1fr !important; }
        }
    </style>

    {% if has_data %}
    <!-- Charts Row -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
        <!-- Emails by Day Chart -->
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px;">
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
                <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Messages by Day (Last 7 Days)</h3>
            </div>
            <div style="padding: 20px; height: 280px;">
                <canvas id="emailsByDayChart"></canvas>
            </div>
        </div>

        <!-- Urgency Ratio Chart -->
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px;">
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
                <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Urgency Distribution</h3>
            </div>
            <div style="padding: 20px; height: 280px; display: flex; align-items: center; justify-content: center;">
                <canvas id="urgencyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Senders -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Top Senders</h3>
        </div>
        <div style="padding: 20px; height: 280px;">
            <canvas id="topSendersChart"></canvas>
        </div>
    </div>

    <!-- Chart Data (passed via data attributes to avoid linter issues with Jinja2 in JS) -->
    <div id="chart-data" 
         data-emails-by-day="{{ emails_by_day | tojson | e }}"
         data-urgency-ratio="{{ urgency_ratio | tojson | e }}"
         data-top-senders="{{ top_senders | tojson | e }}"
         style="display: none;"></div>

    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var dataEl = document.getElementById('chart-data');
            if (!dataEl) return;
            
            try {
                var emailsByDayData = JSON.parse(dataEl.dataset.emailsByDay || '[]');
                var urgencyData = JSON.parse(dataEl.dataset.urgencyRatio || '{"urgent":0,"not_urgent":0}');
                var topSendersData = JSON.parse(dataEl.dataset.topSenders || '[]');

                var chartColors = {
                    primary: '#fafafa',
                    danger: '#ef4444',
                    success: '#22c55e',
                    warning: '#f59e0b',
                    neutral: '#a3a3a3',
                    gray: '#525252'
                };

                // Emails by Day Line Chart
                var emailsCtx = document.getElementById('emailsByDayChart');
                if (emailsCtx) {
                    new Chart(emailsCtx, {
                        type: 'line',
                        data: {
                            labels: emailsByDayData.map(function(d) { return d.date.slice(5); }),
                            datasets: [{
                                label: 'Messages',
                                data: emailsByDayData.map(function(d) { return d.count; }),
                                borderColor: chartColors.primary,
                                backgroundColor: 'rgba(250, 250, 250, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 4,
                                pointBackgroundColor: chartColors.primary
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } },
                                x: { grid: { display: false }, ticks: { color: '#71717a' } }
                            }
                        }
                    });
                }

                // Urgency Ratio Doughnut Chart
                var urgencyCtx = document.getElementById('urgencyChart');
                if (urgencyCtx) {
                    new Chart(urgencyCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Urgent', 'Not Urgent'],
                            datasets: [{
                                data: [urgencyData.urgent, urgencyData.not_urgent],
                                backgroundColor: [chartColors.danger, chartColors.gray],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: '#a1a1aa', padding: 16 } }
                            },
                            cutout: '65%'
                        }
                    });
                }

                // Top Senders Bar Chart
                var sendersCtx = document.getElementById('topSendersChart');
                if (sendersCtx) {
                    new Chart(sendersCtx, {
                        type: 'bar',
                        data: {
                            labels: topSendersData.map(function(d) { return d.sender.length > 25 ? d.sender.slice(0, 22) + '...' : d.sender; }),
                            datasets: [{
                                label: 'Messages',
                                data: topSendersData.map(function(d) { return d.count; }),
                                backgroundColor: chartColors.neutral,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } },
                                y: { grid: { display: false }, ticks: { color: '#a1a1aa' } }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Chart initialization error:', e);
            }
        });
    </script>
    {% else %}
    <!-- Empty State -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 60px 20px; text-align: center;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" style="margin-bottom: 16px;">
            <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>
        </svg>
        <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 8px;">No Data Yet</h3>
        <p style="color: var(--text-muted); font-size: 14px; margin: 0;">Start checking emails to see analytics here.</p>
        <a href="/" class="btn btn-primary" style="margin-top: 20px;">Go to Dashboard</a>
    </div>
    {% endif %}
</div>
{% endblock %}
