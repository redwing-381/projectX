{% extends "base.html" %}

{% block title %}Settings - ProjectX{% endblock %}

{% block content %}
<style>
    .status-dot-active { background: #22c55e; }
    .status-dot-inactive { background: var(--text-muted); }
    .status-badge-active { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-badge-inactive { background: var(--bg-tertiary); color: var(--text-muted); }
    .status-badge-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .stat-value-active { color: #22c55e; }
    .stat-value-inactive { color: var(--text-muted); }
    .db-status-connected { color: #22c55e; }
    .db-status-disconnected { color: #ef4444; }
</style>
<div class="page-header">
    <div>
        <h1 style="font-size: 24px; font-weight: 700; margin: 0;">Settings</h1>
        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Configure your notification monitoring preferences</p>
    </div>
</div>

<div class="page-content">
    <!-- Phone Number -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Alert Phone Number</h3>
        </div>
        <div style="padding: 20px;">
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0 0 16px 0;">SMS alerts will be sent to this number when urgent messages are detected.</p>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: var(--bg-tertiary); border-radius: 6px; padding: 10px 14px; font-family: monospace; font-size: 13px;">
                    {{ phone_masked or 'Not configured' }}
                </div>
                <span style="color: var(--text-muted); font-size: 12px;">(Configured via environment variable)</span>
            </div>
        </div>
    </div>

    <!-- Unified Monitoring Control -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Monitoring Control</h3>
        </div>
        <div style="padding: 20px;">
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0 0 20px 0;">Control monitoring across all platforms from one place.</p>
            
            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <form action="/settings/start-all-monitoring" method="post" style="margin: 0;">
                    <button type="submit" class="btn btn-success" style="padding: 10px 20px;">Start All Monitoring</button>
                </form>
                <form action="/settings/stop-all-monitoring" method="post" style="margin: 0;">
                    <button type="submit" class="btn btn-danger" style="padding: 10px 20px;">Stop All Monitoring</button>
                </form>
            </div>
            
            <!-- Email Monitoring Section -->
            <div style="border-top: 1px solid var(--sidebar-border); padding-top: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="width: 8px; height: 8px; border-radius: 50%;" class="{% if monitoring_enabled %}status-dot-active{% else %}status-dot-inactive{% endif %}"></span>
                        <div>
                            <h4 style="font-weight: 500; margin: 0; font-size: 14px;">Email Monitoring</h4>
                            <p style="color: var(--text-muted); font-size: 12px; margin: 2px 0 0 0;">Automatically check Gmail at regular intervals</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;" class="{% if monitoring_enabled %}status-badge-active{% else %}status-badge-inactive{% endif %}">
                            {% if monitoring_enabled %}Active{% else %}Inactive{% endif %}
                        </span>
                        <form action="/settings/toggle-scheduled-monitoring" method="post" style="margin: 0;">
                            {% if monitoring_enabled %}
                            <button type="submit" class="btn btn-danger" style="padding: 6px 14px; font-size: 12px;">Stop</button>
                            {% else %}
                            <button type="submit" class="btn btn-success" style="padding: 6px 14px; font-size: 12px;">Start</button>
                            {% endif %}
                        </form>
                    </div>
                </div>
                
                <form action="/settings/set-interval" method="post" style="display: flex; align-items: center; gap: 12px;">
                    <label style="color: var(--text-muted); font-size: 13px;">Check interval:</label>
                    <select name="interval" style="background: var(--bg-tertiary); border: 1px solid var(--sidebar-border); border-radius: 6px; padding: 6px 10px; color: var(--text-primary); font-size: 13px;">
                        <option value="1" {% if check_interval == 1 %}selected{% endif %}>1 min</option>
                        <option value="2" {% if check_interval == 2 %}selected{% endif %}>2 min</option>
                        <option value="5" {% if check_interval == 5 %}selected{% endif %}>5 min</option>
                        <option value="10" {% if check_interval == 10 %}selected{% endif %}>10 min</option>
                        <option value="15" {% if check_interval == 15 %}selected{% endif %}>15 min</option>
                        <option value="30" {% if check_interval == 30 %}selected{% endif %}>30 min</option>
                    </select>
                    <button type="submit" class="btn btn-primary" style="padding: 6px 14px; font-size: 12px;">Save</button>
                </form>
            </div>
            
            <!-- Mobile Monitoring Section -->
            <div style="border-top: 1px solid var(--sidebar-border); padding-top: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="width: 8px; height: 8px; border-radius: 50%;" class="{% if mobile_monitoring_enabled %}status-dot-active{% else %}status-dot-inactive{% endif %}"></span>
                        <div>
                            <h4 style="font-weight: 500; margin: 0; font-size: 14px;">Mobile App Monitoring</h4>
                            <p style="color: var(--text-muted); font-size: 12px; margin: 2px 0 0 0;">Capture notifications from WhatsApp, Telegram, etc.</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500;" class="status-badge-inactive">
                            {% if device_count > 0 %}{{ mobile_enabled_count }}/{{ device_count }} devices{% else %}No devices{% endif %}
                        </span>
                        {% if device_count > 0 %}
                        <form action="/settings/toggle-mobile-monitoring" method="post" style="margin: 0;">
                            {% if mobile_monitoring_enabled %}
                            <button type="submit" class="btn btn-danger" style="padding: 6px 14px; font-size: 12px;">Stop All</button>
                            {% else %}
                            <button type="submit" class="btn btn-success" style="padding: 6px 14px; font-size: 12px;">Start All</button>
                            {% endif %}
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile App Integration -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Mobile App Integration</h3>
        </div>
        <div style="padding: 20px;">
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0 0 20px 0;">Connect your Android device to sync notifications from messaging apps.</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 20px;">
                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600;" class="{% if device_count > 0 %}stat-value-active{% else %}stat-value-inactive{% endif %}">{{ device_count }}</div>
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Connected Devices</div>
                </div>
                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600;">{{ mobile_notification_count }}</div>
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Mobile Notifications</div>
                </div>
                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600;">{% if last_sync %}{{ last_sync.strftime('%H:%M') }}{% else %}--{% endif %}</div>
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Last Sync</div>
                </div>
            </div>

            {% if devices %}
            <div style="border-top: 1px solid var(--sidebar-border); padding-top: 20px;">
                <h4 style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 12px 0;">Connected Devices</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% for device in devices %}
                    <div style="display: flex; align-items: center; justify-content: space-between; background: var(--bg-tertiary); border-radius: 8px; padding: 14px 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="width: 8px; height: 8px; border-radius: 50%;" class="status-dot-active"></span>
                            <div>
                                <p style="font-weight: 500; margin: 0; font-size: 14px;">{{ device.device_name or device.device_id[:12] }}...</p>
                                <p style="font-size: 12px; color: var(--text-muted); margin: 2px 0 0 0;">{{ device.notification_count }} notifications synced</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 11px; color: var(--text-muted); margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">Last sync</p>
                            <p style="font-size: 13px; margin: 2px 0 0 0;">{{ device.last_sync_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div style="border-top: 1px solid var(--sidebar-border); padding-top: 20px; text-align: center; padding: 32px 20px;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" style="margin: 0 auto 12px; opacity: 0.5;">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                    <line x1="12" y1="18" x2="12.01" y2="18"/>
                </svg>
                <p style="color: var(--text-muted); margin: 0; font-size: 14px;">No devices connected yet</p>
                <p style="color: var(--text-muted); font-size: 12px; margin: 4px 0 0 0;">Install the Android app and sync to get started</p>
            </div>
            {% endif %}

            <!-- API Key Status -->
            <div style="border-top: 1px solid var(--sidebar-border); padding-top: 20px; margin-top: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <p style="font-weight: 500; margin: 0; font-size: 14px;">API Key Status</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin: 2px 0 0 0;">Required for mobile app authentication</p>
                    </div>
                    <span style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;" class="{% if api_key_configured %}status-badge-active{% else %}status-badge-warning{% endif %}">
                        {% if api_key_configured %}Configured{% else %}Not Set{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Quick Actions</h3>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                <form action="/web/check" method="post" style="margin: 0;">
                    <button type="submit" class="btn btn-primary">Check Emails Now</button>
                </form>
                <form action="/test-urgent" method="post" style="margin: 0;">
                    <button type="submit" class="btn btn-secondary">Test SMS Alert</button>
                </form>
            </div>
        </div>
    </div>

    <!-- System Info -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">System Information</h3>
        </div>
        <div style="padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px;">
                <div>
                    <p style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Server Status</p>
                    <p style="font-weight: 500; margin: 4px 0 0 0; font-size: 14px;" class="db-status-connected">Online</p>
                </div>
                <div>
                    <p style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Database</p>
                    <p style="font-weight: 500; margin: 4px 0 0 0; font-size: 14px;" class="{% if db_connected %}db-status-connected{% else %}db-status-disconnected{% endif %}">
                        {% if db_connected %}Connected{% else %}Not Connected{% endif %}
                    </p>
                </div>
                <div>
                    <p style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">VIP Senders</p>
                    <p style="font-weight: 500; margin: 4px 0 0 0; font-size: 14px;">{{ vip_count }}</p>
                </div>
                <div>
                    <p style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Keyword Rules</p>
                    <p style="font-weight: 500; margin: 4px 0 0 0; font-size: 14px;">{{ keyword_count }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
