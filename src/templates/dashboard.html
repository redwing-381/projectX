{% extends "base.html" %}

{% block title %}Dashboard - ProjectX{% endblock %}

{% block content %}
<style>
    .alert-box { margin-bottom: 24px; padding: 14px 20px; border-radius: 8px; }
    .alert-success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); }
    .alert-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
    .alert-text { margin: 0; font-weight: 500; font-size: 14px; }
    .text-success { color: #22c55e; }
    .text-error { color: #ef4444; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot-green { background: #22c55e; }
    .status-dot-gray { background: #6b7280; }
    @media (max-width: 900px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr) !important; }
    }
    @media (max-width: 500px) {
        .stats-grid { grid-template-columns: 1fr !important; }
    }
</style>

<div class="page-header">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
            <h1 style="font-size: 24px; font-weight: 700; margin: 0;">Dashboard</h1>
            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Monitor your notifications and alerts</p>
        </div>
        <form action="/web/check" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Check Emails
            </button>
        </form>
    </div>
</div>

<div class="page-content">
    {% if check_result %}
    <div class="alert-box {% if check_result.success %}alert-success{% else %}alert-error{% endif %}">
        <p class="alert-text {% if check_result.success %}text-success{% else %}text-error{% endif %}">{{ check_result.message }}</p>
    </div>
    {% endif %}

    <!-- Stats -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="status-dot status-dot-green" style="box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Server Status</span>
            </div>
            <div style="font-size: 24px; font-weight: 600; color: #22c55e;">Online</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="status-dot {% if device_count > 0 %}status-dot-green{% else %}status-dot-gray{% endif %}"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Mobile Devices</span>
            </div>
            <div style="font-size: 24px; font-weight: 600;">{{ device_count }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="status-dot" style="background: #8b5cf6;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Emails Checked</span>
            </div>
            <div style="font-size: 24px; font-weight: 600;">{{ stats.emails_checked }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="status-dot" style="background: #ef4444;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">SMS Alerts Sent</span>
            </div>
            <div style="font-size: 24px; font-weight: 600;">{{ stats.alerts_sent }}</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Quick Actions</h3>
        </div>
        <div style="padding: 20px; display: flex; flex-wrap: wrap; gap: 12px;">
            <form action="/web/check" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-primary">Check Emails</button>
            </form>
            <form action="/test-urgent" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary">Test SMS Alert</button>
            </form>
            {% if not demo_mode %}
            <form action="/demo/activate" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary btn-demo">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                    Try Demo Mode
                </button>
            </form>
            {% endif %}
            <a href="/analytics" class="btn btn-secondary">View Analytics</a>
            <a href="/settings" class="btn btn-secondary">Settings</a>
        </div>
    </div>

    <!-- Notification Sources -->
    {% if source_counts %}
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Notifications by Source</h3>
        </div>
        <div style="padding: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
            {% for source, count in source_counts.items() %}
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--bg-tertiary); border-radius: 6px;">
                {% if 'whatsapp' in source %}
                <span class="status-dot" style="background: #25D366;"></span>
                <span style="font-size: 13px;">WhatsApp</span>
                {% elif 'instagram' in source %}
                <span class="status-dot" style="background: #E4405F;"></span>
                <span style="font-size: 13px;">Instagram</span>
                {% elif 'telegram' in source %}
                <span class="status-dot" style="background: #0088cc;"></span>
                <span style="font-size: 13px;">Telegram</span>
                {% elif 'slack' in source %}
                <span class="status-dot" style="background: #4A154B;"></span>
                <span style="font-size: 13px;">Slack</span>
                {% elif 'discord' in source %}
                <span class="status-dot" style="background: #5865F2;"></span>
                <span style="font-size: 13px;">Discord</span>
                {% elif 'messenger' in source %}
                <span class="status-dot" style="background: #0084FF;"></span>
                <span style="font-size: 13px;">Messenger</span>
                {% elif 'sms' in source %}
                <span class="status-dot" style="background: #6B7280;"></span>
                <span style="font-size: 13px;">SMS</span>
                {% elif source == 'email' %}
                <span class="status-dot" style="background: #EA4335;"></span>
                <span style="font-size: 13px;">Email</span>
                {% else %}
                <span class="status-dot" style="background: #6B7280;"></span>
                <span style="font-size: 13px;">{{ source }}</span>
                {% endif %}
                <span style="color: var(--text-muted); font-weight: 600; font-size: 13px;">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Alerts -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Recent Alerts</h3>
            <a href="/history" style="color: var(--accent-primary); font-size: 13px; text-decoration: none;">View All</a>
        </div>
        {% if recent_alerts %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--sidebar-border);">
                        <th style="padding: 12px 20px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Source</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Sender</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Subject</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Status</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">SMS</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Time</th>
                        <th style="padding: 12px 20px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in recent_alerts %}
                    <tr style="border-bottom: 1px solid var(--sidebar-border);">
                        <td style="padding: 14px 20px;">
                            {% if 'whatsapp' in (alert.source or '') %}
                            <span class="source-badge source-whatsapp">WA</span>
                            {% elif 'instagram' in (alert.source or '') %}
                            <span class="source-badge source-instagram">IG</span>
                            {% elif 'telegram' in (alert.source or '') %}
                            <span class="source-badge source-telegram">TG</span>
                            {% elif 'slack' in (alert.source or '') %}
                            <span class="source-badge source-slack">SL</span>
                            {% elif 'discord' in (alert.source or '') %}
                            <span class="source-badge source-discord">DC</span>
                            {% elif 'messenger' in (alert.source or '') %}
                            <span class="source-badge source-messenger">FB</span>
                            {% elif 'sms' in (alert.source or '') %}
                            <span class="source-badge source-sms">SMS</span>
                            {% else %}
                            <span class="source-badge source-email">EM</span>
                            {% endif %}
                        </td>
                        <td style="padding: 14px 16px; font-size: 13px;">{{ alert.sender[:30] }}{% if alert.sender|length > 30 %}...{% endif %}</td>
                        <td style="padding: 14px 16px; font-size: 13px; color: var(--text-secondary);">{{ alert.subject[:40] }}{% if alert.subject|length > 40 %}...{% endif %}</td>
                        <td style="padding: 14px 16px;">
                            {% if alert.urgency == 'URGENT' %}
                            <span class="urgency-badge urgency-urgent">Urgent</span>
                            {% else %}
                            <span class="urgency-badge urgency-normal">Normal</span>
                            {% endif %}
                        </td>
                        <td style="padding: 14px 16px;">
                            {% if alert.sms_sent %}
                            <span class="status-dot status-dot-green" style="display: inline-block;"></span>
                            {% else %}
                            <span style="color: var(--text-muted);">â€”</span>
                            {% endif %}
                        </td>
                        <td style="padding: 14px 16px; font-size: 13px; color: var(--text-muted);">{{ alert.created_at.strftime('%H:%M') }}</td>
                        <td style="padding: 14px 20px;">
                            <button class="btn-add-vip" data-sender="{{ alert.sender }}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>VIP
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding: 48px 20px; text-align: center;">
            <p style="color: var(--text-muted); margin: 0; font-size: 14px;">No alerts yet. Run an email check or sync from mobile app to get started.</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .btn-demo { background: linear-gradient(90deg, #f59e0b, #d97706); color: #000; border: none; }
    .source-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .source-whatsapp { background: rgba(37, 211, 102, 0.15); color: #25D366; }
    .source-instagram { background: rgba(228, 64, 95, 0.15); color: #E4405F; }
    .source-telegram { background: rgba(0, 136, 204, 0.15); color: #0088cc; }
    .source-slack { background: rgba(74, 21, 75, 0.15); color: #E01E5A; }
    .source-discord { background: rgba(88, 101, 242, 0.15); color: #5865F2; }
    .source-messenger { background: rgba(0, 132, 255, 0.15); color: #0084FF; }
    .source-sms { background: rgba(107, 114, 128, 0.15); color: #9CA3AF; }
    .source-email { background: rgba(234, 67, 53, 0.15); color: #EA4335; }
    .urgency-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .urgency-urgent { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .urgency-normal { background: var(--bg-tertiary); color: var(--text-muted); }
    .btn-add-vip { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: none; cursor: pointer; }
</style>

<script>
document.querySelectorAll('.btn-add-vip').forEach(btn => {
    btn.addEventListener('click', async function() {
        const sender = this.dataset.sender;
        const button = this;
        button.disabled = true;
        button.innerHTML = '...';
        
        try {
            const response = await fetch('/api/quick-actions/add-vip?sender=' + encodeURIComponent(sender), {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                if (data.already_vip) {
                    button.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="vertical-align: middle;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
                    button.style.background = 'rgba(245, 158, 11, 0.15)';
                    button.style.color = '#f59e0b';
                    button.title = 'Already VIP';
                } else {
                    button.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><polyline points="20 6 9 17 4 12"/></svg>';
                    button.style.background = 'rgba(34, 197, 94, 0.15)';
                    button.style.color = '#22c55e';
                    button.title = 'Added to VIP';
                }
            } else {
                button.innerHTML = 'Error';
                button.style.background = 'rgba(239, 68, 68, 0.15)';
                button.style.color = '#ef4444';
            }
        } catch (e) {
            button.innerHTML = 'Error';
            button.style.background = 'rgba(239, 68, 68, 0.15)';
            button.style.color = '#ef4444';
        }
    });
});
</script>
{% endblock %}
