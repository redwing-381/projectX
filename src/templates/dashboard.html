{% extends "base.html" %}

{% block title %}Dashboard - ProjectX{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold">Dashboard</h1>
        <form action="/web/check" method="post" class="inline">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                ðŸ”„ Check Emails Now
            </button>
        </form>
    </div>

    <!-- Check Result Message -->
    {% if check_result %}
    <div class="bg-{% if check_result.success %}green{% else %}red{% endif %}-900 border border-{% if check_result.success %}green{% else %}red{% endif %}-700 rounded-xl p-4">
        <p class="font-medium">{{ check_result.message }}</p>
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Server Status -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-400 text-sm font-medium">Server Status</h3>
                <span class="text-green-400 text-2xl">âœ“</span>
            </div>
            <p class="text-2xl font-bold mt-2 text-green-400">Online</p>
            <p class="text-gray-500 text-sm mt-1">Pipeline ready</p>
        </div>

        <!-- Mobile App Sync -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-400 text-sm font-medium">Mobile App</h3>
                <span class="text-{% if device_count > 0 %}green{% else %}gray{% endif %}-400 text-2xl">ðŸ“±</span>
            </div>
            <p class="text-2xl font-bold mt-2 text-{% if device_count > 0 %}green{% else %}gray{% endif %}-400">
                {{ device_count }} Device{% if device_count != 1 %}s{% endif %}
            </p>
            <p class="text-gray-500 text-sm mt-1">
                {% if last_sync %}Last sync: {{ last_sync.strftime('%H:%M') }}{% else %}No sync yet{% endif %}
            </p>
        </div>

        <!-- Emails Checked Today -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-400 text-sm font-medium">Emails Checked Today</h3>
                <span class="text-blue-400 text-2xl">ðŸ“§</span>
            </div>
            <p class="text-2xl font-bold mt-2">{{ stats.emails_checked }}</p>
            <p class="text-gray-500 text-sm mt-1">Processed emails</p>
        </div>

        <!-- Alerts Sent Today -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-gray-400 text-sm font-medium">Alerts Sent Today</h3>
                <span class="text-red-400 text-2xl">ðŸ””</span>
            </div>
            <p class="text-2xl font-bold mt-2">{{ stats.alerts_sent }}</p>
            <p class="text-gray-500 text-sm mt-1">SMS notifications</p>
        </div>
    </div>

    <!-- Notification Sources Breakdown -->
    {% if source_counts %}
    <div class="bg-gray-800 rounded-xl border border-gray-700 p-6">
        <h2 class="text-xl font-semibold mb-4">Notifications by Source</h2>
        <div class="flex flex-wrap gap-3">
            {% for source, count in source_counts.items() %}
            <div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-700">
                {% if 'whatsapp' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #25D366;"></span>
                <span>WhatsApp</span>
                {% elif 'instagram' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #E4405F;"></span>
                <span>Instagram</span>
                {% elif 'telegram' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #0088cc;"></span>
                <span>Telegram</span>
                {% elif 'slack' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #4A154B;"></span>
                <span>Slack</span>
                {% elif 'discord' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #5865F2;"></span>
                <span>Discord</span>
                {% elif 'messenger' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #0084FF;"></span>
                <span>Messenger</span>
                {% elif 'sms' in source %}
                <span class="w-3 h-3 rounded-full" style="background-color: #6B7280;"></span>
                <span>SMS</span>
                {% elif source == 'email' %}
                <span class="w-3 h-3 rounded-full" style="background-color: #EA4335;"></span>
                <span>Email</span>
                {% else %}
                <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                <span>{{ source }}</span>
                {% endif %}
                <span class="text-gray-400 font-medium">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Alerts -->
    <div class="bg-gray-800 rounded-xl border border-gray-700">
        <div class="px-6 py-4 border-b border-gray-700">
            <h2 class="text-xl font-semibold">Recent Alerts</h2>
        </div>
        <div class="p-6">
            {% if recent_alerts %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 text-sm">
                            <th class="pb-3">Source</th>
                            <th class="pb-3">Sender</th>
                            <th class="pb-3">Subject</th>
                            <th class="pb-3">Status</th>
                            <th class="pb-3">SMS</th>
                            <th class="pb-3">Time</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for alert in recent_alerts %}
                        <tr>
                            <td class="py-3">
                                {% if 'whatsapp' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(37, 211, 102, 0.2); color: #25D366;">WA</span>
                                {% elif 'instagram' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(228, 64, 95, 0.2); color: #E4405F;">IG</span>
                                {% elif 'telegram' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(0, 136, 204, 0.2); color: #0088cc;">TG</span>
                                {% elif 'slack' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(74, 21, 75, 0.2); color: #E01E5A;">SL</span>
                                {% elif 'discord' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(88, 101, 242, 0.2); color: #5865F2;">DC</span>
                                {% elif 'messenger' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(0, 132, 255, 0.2); color: #0084FF;">FB</span>
                                {% elif 'sms' in (alert.source or '') %}
                                <span class="px-2 py-1 rounded text-xs font-medium bg-gray-700 text-gray-300">SMS</span>
                                {% else %}
                                <span class="px-2 py-1 rounded text-xs font-medium" style="background-color: rgba(234, 67, 53, 0.2); color: #EA4335;">ðŸ“§</span>
                                {% endif %}
                            </td>
                            <td class="py-3 text-sm">{{ alert.sender[:30] }}{% if alert.sender|length > 30 %}...{% endif %}</td>
                            <td class="py-3 text-sm">{{ alert.subject[:40] }}{% if alert.subject|length > 40 %}...{% endif %}</td>
                            <td class="py-3">
                                {% if alert.urgency == 'URGENT' %}
                                <span class="px-2 py-1 bg-red-900 text-red-300 rounded text-xs font-medium">URGENT</span>
                                {% else %}
                                <span class="px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs font-medium">Normal</span>
                                {% endif %}
                            </td>
                            <td class="py-3">
                                {% if alert.sms_sent %}
                                <span class="text-green-400">âœ“</span>
                                {% else %}
                                <span class="text-gray-500">-</span>
                                {% endif %}
                            </td>
                            <td class="py-3 text-sm text-gray-400">{{ alert.created_at.strftime('%H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">No alerts yet. Run an email check or sync from mobile app to get started.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
