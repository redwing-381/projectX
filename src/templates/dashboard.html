{% extends "base.html" %}

{% block title %}Dashboard - ProjectX{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
            <h1 style="font-size: 24px; font-weight: 700; margin: 0;">Dashboard</h1>
            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Monitor your notifications and alerts</p>
        </div>
        <form action="/web/check" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Check Emails
            </button>
        </form>
    </div>
</div>

<div class="page-content">
    {% if check_result %}
    <div style="margin-bottom: 24px; padding: 14px 20px; border-radius: 8px; background: {% if check_result.success %}rgba(34, 197, 94, 0.1){% else %}rgba(239, 68, 68, 0.1){% endif %}; border: 1px solid {% if check_result.success %}rgba(34, 197, 94, 0.3){% else %}rgba(239, 68, 68, 0.3){% endif %};">
        <p style="margin: 0; color: {% if check_result.success %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 500; font-size: 14px;">{{ check_result.message }}</p>
    </div>
    {% endif %}

    <!-- Stats -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Server Status</span>
            </div>
            <div style="font-size: 24px; font-weight: 600; color: #22c55e;">Online</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: {% if device_count > 0 %}#22c55e{% else %}#6b7280{% endif %};"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Mobile Devices</span>
            </div>
            <div style="font-size: 24px; font-weight: 600;">{{ device_count }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #8b5cf6;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">Emails Checked</span>
            </div>
            <div style="font-size: 24px; font-weight: 600;">{{ stats.emails_checked }}</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                <span style="font-size: 13px; color: var(--text-muted);">SMS Alerts Sent</span>
            </div>
            <div style="font-size: 24px; font-weight: 600;">{{ stats.alerts_sent }}</div>
        </div>
    </div>

    <style>
        @media (max-width: 900px) {
            .page-content > div:first-of-type + div { grid-template-columns: repeat(2, 1fr) !important; }
        }
        @media (max-width: 500px) {
            .page-content > div:first-of-type + div { grid-template-columns: 1fr !important; }
        }
    </style>

    <!-- Quick Actions -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Quick Actions</h3>
        </div>
        <div style="padding: 20px; display: flex; flex-wrap: wrap; gap: 12px;">
            <form action="/web/check" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-primary">Check Emails</button>
            </form>
            <form action="/test-urgent" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary">Test SMS Alert</button>
            </form>
            <a href="/settings" class="btn btn-secondary">Settings</a>
        </div>
    </div>

    <!-- Notification Sources -->
    {% if source_counts %}
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px; margin-bottom: 24px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border);">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Notifications by Source</h3>
        </div>
        <div style="padding: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
            {% for source, count in source_counts.items() %}
            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--bg-tertiary); border-radius: 6px;">
                {% if 'whatsapp' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #25D366;"></span>
                <span style="font-size: 13px;">WhatsApp</span>
                {% elif 'instagram' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #E4405F;"></span>
                <span style="font-size: 13px;">Instagram</span>
                {% elif 'telegram' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #0088cc;"></span>
                <span style="font-size: 13px;">Telegram</span>
                {% elif 'slack' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #4A154B;"></span>
                <span style="font-size: 13px;">Slack</span>
                {% elif 'discord' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #5865F2;"></span>
                <span style="font-size: 13px;">Discord</span>
                {% elif 'messenger' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #0084FF;"></span>
                <span style="font-size: 13px;">Messenger</span>
                {% elif 'sms' in source %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #6B7280;"></span>
                <span style="font-size: 13px;">SMS</span>
                {% elif source == 'email' %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #EA4335;"></span>
                <span style="font-size: 13px;">Email</span>
                {% else %}
                <span style="width: 8px; height: 8px; border-radius: 50%; background: #6B7280;"></span>
                <span style="font-size: 13px;">{{ source }}</span>
                {% endif %}
                <span style="color: var(--text-muted); font-weight: 600; font-size: 13px;">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Alerts -->
    <div style="background: var(--bg-secondary); border: 1px solid var(--sidebar-border); border-radius: 12px;">
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--sidebar-border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 15px; font-weight: 600; margin: 0;">Recent Alerts</h3>
            <a href="/history" style="color: var(--accent-primary); font-size: 13px; text-decoration: none;">View All</a>
        </div>
        {% if recent_alerts %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--sidebar-border);">
                        <th style="padding: 12px 20px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Source</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Sender</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Subject</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Status</th>
                        <th style="padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">SMS</th>
                        <th style="padding: 12px 20px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in recent_alerts %}
                    <tr style="border-bottom: 1px solid var(--sidebar-border);">
                        <td style="padding: 14px 20px;">
                            {% if 'whatsapp' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(37, 211, 102, 0.15); color: #25D366;">WA</span>
                            {% elif 'instagram' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(228, 64, 95, 0.15); color: #E4405F;">IG</span>
                            {% elif 'telegram' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(0, 136, 204, 0.15); color: #0088cc;">TG</span>
                            {% elif 'slack' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(74, 21, 75, 0.15); color: #E01E5A;">SL</span>
                            {% elif 'discord' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(88, 101, 242, 0.15); color: #5865F2;">DC</span>
                            {% elif 'messenger' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(0, 132, 255, 0.15); color: #0084FF;">FB</span>
                            {% elif 'sms' in (alert.source or '') %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(107, 114, 128, 0.15); color: #9CA3AF;">SMS</span>
                            {% else %}
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(234, 67, 53, 0.15); color: #EA4335;">EM</span>
                            {% endif %}
                        </td>
                        <td style="padding: 14px 16px; font-size: 13px;">{{ alert.sender[:30] }}{% if alert.sender|length > 30 %}...{% endif %}</td>
                        <td style="padding: 14px 16px; font-size: 13px; color: var(--text-secondary);">{{ alert.subject[:40] }}{% if alert.subject|length > 40 %}...{% endif %}</td>
                        <td style="padding: 14px 16px;">
                            {% if alert.urgency == 'URGENT' %}
                            <span style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; background: rgba(239, 68, 68, 0.15); color: #ef4444;">Urgent</span>
                            {% else %}
                            <span style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--bg-tertiary); color: var(--text-muted);">Normal</span>
                            {% endif %}
                        </td>
                        <td style="padding: 14px 16px;">
                            {% if alert.sms_sent %}
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e; display: inline-block;"></span>
                            {% else %}
                            <span style="color: var(--text-muted);">â€”</span>
                            {% endif %}
                        </td>
                        <td style="padding: 14px 20px; font-size: 13px; color: var(--text-muted);">{{ alert.created_at.strftime('%H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding: 48px 20px; text-align: center;">
            <p style="color: var(--text-muted); margin: 0; font-size: 14px;">No alerts yet. Run an email check or sync from mobile app to get started.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
